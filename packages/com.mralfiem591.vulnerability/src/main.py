import paxd_sdk # type: ignore
from colorama import Fore, Style, init
import datetime

init(autoreset=True)

found = False
bef = datetime.datetime.now()

# Step one: get repository url via sdk
repo_url = paxd_sdk.Repository.GetRepositoryUrl()

# Step two: get all installed packages via sdk
installed_packages = paxd_sdk.Package.ListInstalled()

# Step three: GET request to repo_url/vulnerabilities to get vulnerability data
import requests

response = requests.get(f"{repo_url}/vulnerabilities", headers={
    "User-Agent": f"PaxDVulnScanner/1.0"})

if response.status_code == 404:
    print("Vulnerability data not found, maybe your default repository does not support it?")
    print("Defaulting to main PaxD repository (https://raw.githubusercontent.com/mralfiem591/paxd/refs/heads/main).")
    repo_url = "https://raw.githubusercontent.com/mralfiem591/paxd/refs/heads/main"

response.raise_for_status()

# Step four: parse vulnerability data
vulnerability_data = paxd_sdk.Helpers.ParseJsonc(response.text)

# Format time taken to just be seconds and 2 decimal places
print(f"Vulnerability data fetched in {(datetime.datetime.now() - bef).total_seconds():.2f} seconds!")

# Step five: DISPLAY!

updated = []

for key, value in vulnerability_data.items():
    package_name = key
    vulnerabilities = value
    
    # Find the package in the installed packages list
    installed_package = None
    for pkg in installed_packages:
        if pkg['name'] == package_name:
            installed_package = pkg
            break
    
    if installed_package:
        installed_version = installed_package['version']
        
        # Ensure vulnerabilities is a list
        if not isinstance(vulnerabilities, list):
            print(f"Warning: Expected vulnerabilities to be a list for package {package_name}, got {type(vulnerabilities)}")
            continue
            
        for vuln in vulnerabilities:
            if not isinstance(vuln, dict):
                print(f"Warning: Expected vulnerability to be a dict, got {type(vuln)}: {vuln}")
                continue
                
            if 'affected_versions' not in vuln:
                print(f"Warning: Vulnerability missing 'affected_versions' field: {vuln}")
                continue
                
            affected_versions = vuln['affected_versions']
            
            print(f"Checking if you are vulnerable to {vuln['id']} in package {package_name}...")
            
            if paxd_sdk.Helpers.AssertVersion(affected_versions, installed_version):
                print(f"{Fore.RED}Vulnerability found in package {package_name} version {installed_version}:")
                found = True
                print(f"{Fore.CYAN}  - ID: {vuln['id']}")
                print(f"{Fore.CYAN}  - Description: {Fore.LIGHTMAGENTA_EX}{vuln['description']}")
                print(f"{Fore.CYAN}  - Severity: {vuln['severity']}")
                if package_name not in updated:
                    if input("Update package now? (y/n): ").lower() == 'y':
                        paxd_sdk.Package.Update(package_name)
                        updated.append(package_name)
                    else:
                        print("Skipping update.")
                        paxd_sdk.Messaging.SendMessage("com.mralfiem591.vulnerability", "com.mralfiem591.paxd", {"message": "Vulnerability found in a package! Please update ASAP.", "vulnerability_id": vuln['id'], "installed_version": installed_version, "severity": vuln['severity'], "description": vuln['description'], "package_name": package_name})
                else:
                    print("Good news! You've already updated this package during this scan. No need to update again.")

if not found:
    print(f"{Fore.GREEN}All good, no vulnerabilities found")
