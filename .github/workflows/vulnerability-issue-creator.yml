name: Vulnerability Issue Creator

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (true/false)'
        required: false
        default: 'false'
      debug:
        description: 'Enable debug mode (true/false)'
        required: false
        default: 'false'
  
  # Run when vulnerabilities file is updated
  push:
    paths:
      - 'vulnerabilities'
      - 'vulnerability_issue_creator.py'
      - '.github/workflows/vulnerability-issue-creator.yml' # Run when this file is edited, to apply changes

jobs:
  create-vulnerability-issues:
    name: Process Vulnerabilities and Create Issues
    runs-on: self-hosted
    
    # Grant necessary permissions to GITHUB_TOKEN
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if vulnerabilities file exists
        id: check_vulns
        run: |
          if [ -f "vulnerabilities" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Vulnerabilities file found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No vulnerabilities file found"
          fi
        shell: bash
      
      - name: Run vulnerability issue creator
        if: steps.check_vulns.outputs.exists == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO_NAME: ${{ github.event.repository.name }}
          # Override with manual inputs if provided
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          DEBUG_MODE: ${{ github.event.inputs.debug || 'false' }}
        run: |
          # Prepare arguments based on inputs
          ARGS=""
          if [ "$DRY_RUN" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          if [ "$DEBUG_MODE" = "true" ]; then
            ARGS="$ARGS --debug"
          fi
          
          echo "Running vulnerability issue creator with args: $ARGS"
          python vulnerability_issue_creator.py $ARGS
        shell: bash
      
      - name: Summary
        if: steps.check_vulns.outputs.exists == 'true'
        run: |
          echo "### Vulnerability Issue Creator Workflow Completed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "- **Mode:** Dry Run (no issues created)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Mode:** Live (issues created/updated)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Debug:** ${{ github.event.inputs.debug || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for detailed results." >> $GITHUB_STEP_SUMMARY
      
      - name: No vulnerabilities file
        if: steps.check_vulns.outputs.exists == 'false'
        run: |
          echo "### No Vulnerabilities File Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The vulnerabilities file was not found in the repository." >> $GITHUB_STEP_SUMMARY
          echo "This workflow will skip processing until a vulnerabilities file is present." >> $GITHUB_STEP_SUMMARY